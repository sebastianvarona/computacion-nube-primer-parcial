<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - Mini Store</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            padding-top: 70px;
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .form-section {
            background-color: #ffffff;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .table-responsive {
            border-radius: 8px;
        }
        .btn-action {
            margin-right: 5px;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .currency {
            text-align: right;
            font-weight: 500;
        }
        .alert {
            border-radius: 8px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="/dashboard">
        <i class="fas fa-store"></i> Mini Store
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/users"><i class="fas fa-users"></i> Users</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/products"><i class="fas fa-box"></i> Products</a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="/orders"><i class="fas fa-shopping-cart"></i> Orders</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4"><i class="fas fa-shopping-cart"></i> Order Management</h1>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Orders will be created using your current session information. 
                Make sure you are logged in with the correct user account.
            </div>
        </div>
    </div>
    
    <div id="message"></div>

    <!-- Add/Edit Order Form -->
    <div class="card form-section">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-plus"></i> <span id="form-title">Create New Order</span></h5>
        </div>
        <div class="card-body">
            <form id="orderForm">
                <input type="hidden" id="orderId" name="orderId">
                
                <!-- Product Selection Section -->
                <div class="form-group">
                    <label><i class="fas fa-box"></i> Select Products:</label>
                    <div class="card border">
                        <div class="card-body">
                            <div id="productsList">
                                <p class="text-center text-muted">Loading products...</p>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Order Total: </strong>
                                    <span class="badge badge-success" style="font-size: 1rem;" id="orderTotal">$0.00</span>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearProductSelections()">
                                    <i class="fas fa-eraser"></i> Clear Selection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="date"><i class="fas fa-calendar"></i> Date:</label>
                    <input type="datetime-local" class="form-control" id="date" name="date">
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-success btn-lg btn-block" id="submitBtn">
                        <i class="fas fa-shopping-cart"></i> Create Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Orders List -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-list"></i> Orders List</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="ordersTable">
                    <thead class="thead-dark">
                        <tr>
                            <th><i class="fas fa-hashtag"></i> ID</th>
                            <th><i class="fas fa-user"></i> Customer</th>
                            <th><i class="fas fa-envelope"></i> Email</th>
                            <th><i class="fas fa-dollar-sign"></i> Total</th>
                            <th><i class="fas fa-calendar"></i> Date</th>
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersBody">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/consul-discovery.js"></script>

<script>
    let API_URL = 'http://192.168.80.3:5004/api/orders'; // fallback
    let PRODUCTS_API = 'http://192.168.80.3:5003/api/products'; // fallback
    
    // Initialize service discovery
    async function initializeServices() {
        try {
            API_URL = await buildApiUrl('microorders', '/api/orders');
            PRODUCTS_API = await buildApiUrl('microproducts', '/api/products');
            console.log('Using service URLs - Orders:', API_URL, 'Products:', PRODUCTS_API);
        } catch (error) {
            console.warn('Service discovery failed, using fallback URLs:', error);
        }
    }
    let products = [];
    let selectedProducts = [];

    // Load orders and products on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await initializeServices();
        loadOrders();
        loadProducts();
        setCurrentDateTime();
    });

    // Handle form submission
    document.getElementById('orderForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate that products are selected
        if (selectedProducts.length === 0) {
            showMessage('Please select at least one product for the order', 'danger');
            return;
        }
        
        const formData = new FormData(this);
        const orderData = {
            products: selectedProducts.map(p => ({
                id: p.id,
                quantity: p.quantity
            }))
        };

        // Include date if provided
        if (formData.get('date')) {
            orderData.date = formData.get('date');
        }

        createOrder(orderData);
    });

    // Load products for selection
    function loadProducts() {
        fetch(PRODUCTS_API)
            .then(response => response.json())
            .then(data => {
                products = data;
                displayProductsForSelection(data);
            })
            .catch(error => {
                document.getElementById('productsList').innerHTML = 
                    '<p class="text-center text-danger">Error loading products</p>';
            });
    }

    // Display products for selection
    function displayProductsForSelection(products) {
        const productsList = document.getElementById('productsList');
        
        if (products.length === 0) {
            productsList.innerHTML = '<p class="text-center text-muted">No products available</p>';
            return;
        }

        let html = '<div class="row">';
        products.forEach(product => {
            const isOutOfStock = product.quantity === 0;
            const stockBadge = product.quantity > 10 ? 
                `<span class="badge badge-success">Stock: ${product.quantity}</span>` :
                product.quantity > 0 ?
                `<span class="badge badge-warning">Stock: ${product.quantity}</span>` :
                `<span class="badge badge-danger">Out of Stock</span>`;

            html += `
                <div class="col-md-6 mb-3">
                    <div class="card ${isOutOfStock ? 'border-secondary' : 'border-primary'}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="card-title mb-1">${product.name}</h6>
                                    <p class="text-success mb-1 font-weight-bold">$${parseFloat(product.price).toFixed(2)}</p>
                                    ${stockBadge}
                                </div>
                                <div class="text-right">
                                    <div class="input-group input-group-sm" style="width: 100px;">
                                        <div class="input-group-prepend">
                                            <button class="btn btn-outline-secondary btn-sm" type="button" 
                                                    onclick="changeProductQuantity(${product.id}, -1)" ${isOutOfStock ? 'disabled' : ''}>
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                        <input type="number" class="form-control form-control-sm text-center" 
                                               id="qty-${product.id}" value="0" min="0" max="${product.quantity}" 
                                               onchange="updateSelectedProduct(${product.id})" ${isOutOfStock ? 'disabled' : ''}>
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary btn-sm" type="button" 
                                                    onclick="changeProductQuantity(${product.id}, 1)" ${isOutOfStock ? 'disabled' : ''}>
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        productsList.innerHTML = html;
    }

    // Change product quantity
    function changeProductQuantity(productId, delta) {
        const input = document.getElementById(`qty-${productId}`);
        let newValue = parseInt(input.value || 0) + delta;
        const product = products.find(p => p.id === productId);
        
        if (newValue < 0) newValue = 0;
        if (newValue > product.quantity) newValue = product.quantity;
        
        input.value = newValue;
        updateSelectedProduct(productId);
    }

    // Update selected product list
    function updateSelectedProduct(productId) {
        const input = document.getElementById(`qty-${productId}`);
        const quantity = parseInt(input.value || 0);
        const product = products.find(p => p.id === productId);
        
        // Remove existing entry
        selectedProducts = selectedProducts.filter(p => p.id !== productId);
        
        // Add if quantity > 0
        if (quantity > 0) {
            selectedProducts.push({
                id: productId,
                name: product.name,
                price: product.price,
                quantity: quantity
            });
        }
        
        updateOrderTotal();
    }

    // Update order total
    function updateOrderTotal() {
        const total = selectedProducts.reduce((sum, product) => {
            return sum + (product.price * product.quantity);
        }, 0);
        
        document.getElementById('orderTotal').textContent = `$${total.toFixed(2)}`;
    }

    // Clear product selections
    function clearProductSelections() {
        if (selectedProducts.length === 0) return;
        
        if (confirm('Are you sure you want to clear all product selections?')) {
            selectedProducts = [];
            products.forEach(product => {
                const input = document.getElementById(`qty-${product.id}`);
                if (input) input.value = 0;
            });
            updateOrderTotal();
            showMessage('Product selections cleared', 'info');
        }
    }

    // Set current date and time
    function setCurrentDateTime() {
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
            .toISOString().slice(0, 16);
        document.getElementById('date').value = localDateTime;
    }

    // Load all orders
    function loadOrders() {
        fetch(API_URL)
            .then(response => response.json())
            .then(data => {
                displayOrders(data);
            })
            .catch(error => {
                showMessage('Error loading orders: ' + error.message, 'danger');
            });
    }

    // Display orders in table
    function displayOrders(orders) {
        const tbody = document.getElementById('ordersBody');
        tbody.innerHTML = '';

        orders.forEach(order => {
            const row = tbody.insertRow();
            const formattedDate = order.date ? new Date(order.date).toLocaleString() : 'N/A';
            const formattedTotal = order.saleTotal ? `$${parseFloat(order.saleTotal).toFixed(2)}` : '$0.00';
            
            row.innerHTML = `
                <td><strong>#${order.id}</strong></td>
                <td>${order.userName || ''}</td>
                <td>${order.userEmail || ''}</td>
                <td class="currency">${formattedTotal}</td>
                <td>${formattedDate}</td>
                <td>
                    <button class="btn btn-danger btn-sm btn-action" onclick="deleteOrder(${order.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;
        });
    }

    // Create new order
    function createOrder(orderData) {
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Order...';
        submitBtn.disabled = true;

        fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData),
            credentials: 'include' // Include session for user auth
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === 'Orden creada exitosamente') {
                showMessage('Order created successfully!', 'success');
                
                // Show order details if available
                if (data.order) {
                    const orderSummary = `
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-receipt"></i> Order #${data.order.orderId} Created</h6>
                            <p class="mb-1"><strong>Customer:</strong> ${data.order.userName}</p>
                            <p class="mb-1"><strong>Total:</strong> $${parseFloat(data.order.saleTotal).toFixed(2)}</p>
                            <p class="mb-0"><strong>Products:</strong> ${data.order.products.length} items</p>
                        </div>
                    `;
                    document.getElementById('message').innerHTML += orderSummary;
                }
                
                resetForm();
                loadOrders();
                loadProducts(); // Refresh products to show updated stock
            } else {
                showMessage(data.message || 'Error creating order', 'danger');
            }
        })
        .catch(error => {
            showMessage('Error creating order: ' + error.message, 'danger');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }


    // Delete order
    function deleteOrder(id) {
        if (confirm('Are you sure you want to delete this order?')) {
            fetch(`${API_URL}/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                showMessage('Order deleted successfully!', 'success');
                loadOrders();
            })
            .catch(error => {
                showMessage('Error deleting order: ' + error.message, 'danger');
            });
        }
    }

    // Reset form
    function resetForm() {
        clearForm();
        setCurrentDateTime();
    }

    // Clear form
    function clearForm() {
        document.getElementById('orderForm').reset();
        document.getElementById('orderId').value = '';
        
        // Reset product selections
        selectedProducts = [];
        products.forEach(product => {
            const input = document.getElementById(`qty-${product.id}`);
            if (input) input.value = 0;
        });
        updateOrderTotal();
    }

    // Show messages
    function showMessage(message, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 5000);
    }
</script>

</body>
</html>
